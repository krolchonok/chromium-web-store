name: Auto Bump Version and Release CRX

on:
  push:
    branches: [master]
    paths-ignore:
      - "src/manifest.json"
      - "en_nolocale/manifest.json"
      - "updates.xml"
      - "updates_en_nolocale.xml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Bump version in manifests and update XML
        id: bump
        shell: bash
        run: |
          set -euo pipefail

          CURRENT=$(jq -r '.version' src/manifest.json)
          if [[ -z "$CURRENT" || "$CURRENT" == "null" ]]; then
            echo "Could not read current version" >&2
            exit 1
          fi

          IFS='.' read -r MAJOR MINOR PATCH BUILD <<< "$CURRENT"
          if [[ -z "${MAJOR:-}" || -z "${MINOR:-}" || -z "${PATCH:-}" ]]; then
            echo "Unexpected version format: $CURRENT" >&2
            exit 1
          fi
          BUILD=${BUILD:-0}
          if ! [[ "$BUILD" =~ ^[0-9]+$ ]]; then
            echo "Build segment is not numeric: $BUILD" >&2
            exit 1
          fi

          NEXT="$MAJOR.$MINOR.$PATCH.$((BUILD + 1))"

          jq --arg v "$NEXT" '.version = $v' src/manifest.json > src/manifest.json.tmp && mv src/manifest.json.tmp src/manifest.json
          jq --arg v "$NEXT" '.version = $v' en_nolocale/manifest.json > en_nolocale/manifest.json.tmp && mv en_nolocale/manifest.json.tmp en_nolocale/manifest.json

          sed -E -i "s/version='[^']+'/version='$NEXT'/" updates.xml
          sed -E -i "s/version='[^']+'/version='$NEXT'/" updates_en_nolocale.xml

          echo "version=$NEXT" >> "$GITHUB_OUTPUT"
          echo "tag=v$NEXT" >> "$GITHUB_OUTPUT"

      - name: Commit and push version bump
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add src/manifest.json en_nolocale/manifest.json updates.xml updates_en_nolocale.xml
          git commit -m "chore: bump version to ${{ steps.bump.outputs.version }}"
          git push origin HEAD:master

      - name: Create and push git tag
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.bump.outputs.tag }}"
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            echo "Tag $TAG already exists"
          else
            git tag "$TAG"
            git push origin "$TAG"
          fi

      - name: Restore private key
        shell: bash
        env:
          CWS_PRIVATE_KEY_B64: ${{ secrets.CWS_PRIVATE_KEY_B64 }}
        run: |
          set -euo pipefail
          if [[ -z "$CWS_PRIVATE_KEY_B64" ]]; then
            echo "Missing secret CWS_PRIVATE_KEY_B64" >&2
            exit 1
          fi
          echo "$CWS_PRIVATE_KEY_B64" | base64 --decode > release-key.pem

      - name: Pack CRX
        id: pack
        shell: bash
        run: |
          set -euo pipefail
          chrome --version
          chrome --no-sandbox --pack-extension=src --pack-extension-key=release-key.pem
          if [[ ! -f src.crx ]]; then
            echo "Expected src.crx was not created" >&2
            exit 1
          fi
          ASSET="Chromium.Web.Store.crx"
          mv src.crx "$ASSET"
          echo "asset=$ASSET" >> "$GITHUB_OUTPUT"

      - name: Create release and upload CRX
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.bump.outputs.tag }}
          tag_name: ${{ steps.bump.outputs.tag }}
          target_commitish: master
          draft: false
          prerelease: false
          generate_release_notes: true
          files: ${{ steps.pack.outputs.asset }}
          overwrite_files: true
          fail_on_unmatched_files: true
